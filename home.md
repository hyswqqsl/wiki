## 青清水利第九次迭代接口设计
### 涉及接口

[套餐接口设计](http://112.124.104.190:10001/soft/wiki/wikis/package) |
[认证接口设计](http://112.124.104.190:10001/soft/wiki/wikis/certity) |
[水位站接口设计](http://112.124.104.190:10001/soft/wiki/wikis/station) |
[千寻位置接口设计](http://112.124.104.190:10001/soft/wiki/wikis/qxwz) |
[分享接口设计](http://112.124.104.190:10001/soft/wiki/wikis/share) |
[BIM参数传递](http://112.124.104.190:10001/soft/wiki/wikis/bim) |
[其他接口设计](http://112.124.104.190:10001/soft/wiki/wikis/other) |

### 一. 用户角色
用户分为simple(默认),identity(实名认证),company(企业认证)，用户一旦注册，即拥有simple角色，一旦完成实名认证即拥有identity角色，完成企业认证即拥有company角色。**每月运行定时任务**对认证进行验证是否过期，如果过期将认证状态改为过期，同时移除用户的identity角色或company角色。前台可以利用角色控制显示；同时增加用户web登录和phone登录角色。

所以用户分为user:simple,user:identity,user:company,user:web
没有user:web角色不能删除项目，网页上绘图，上传全景
> 
1. 拥有identity角色的，才能购买套餐，才能对套餐升级和续费
2. 拥有identity角色的，才能购买测站和续费
3. 拥有identity角色的，才能进行企业认证

后台可以去除IsPersonalCertify和IsCompanyCertify两个标签，采用shiro用户角色验证。

### 二. 项目特殊权限
qxwz(千寻位置),bim(bim协同)这两个权限附加在项目上，每次进行这两种操作时，都应该先向后台发请求
判断，当前操作的项目是否拥有权限。
>
1. 判断是够有千寻连接权限：qxwz/isAllowQxwz,GET，后台有IsFindCM标签，感觉不用定义标签
2. 判断是够有bim协同权限：project/isAllowBim,GET，后台有IsBim标签，感觉不用定义标签

### 三. 套餐过期
套餐过期后，所有操作都不能进行，如建立项目、绑定子账号、编辑项目要素、上传文件、上传工程布置、地图上绘图、编辑水文站、不能上传外业勘测数据，这些涉及到的操作都要判断套餐是否过期，这些操作后台上都加上判断套餐未过期标签**IsExpire**，返回EXPIRE类型的消息。

### 四. 套餐限制
每种套餐都有限制，分为空间数、项目数、子账号数、全景数、千寻连接数，这些连接时都要判断是否超过限制，后台标签使用切面方式控制；由于前台的文件是由浏览器直接上传到阿里云的，因此文件上传、下载、删除需要先访问后台接口，判断是否允许上传，上传完文件再访问后台接口，告诉后台上传了多大的文件，让后台记录空间数变化；删除文件后也要访问后台接口，让后台记录空间数变化,同时记录日志；空间数只是限制阿里云空间大小，但是阿里云收费除了空间大小外，还有流量费，为了防止用户恶意操作浪费流量，还要限制流量使用，上传和下载流量最大是空间大小的10倍。

### 五. 后台标签
1. 综上所述，后台标签大部分只用一次，就不需要定义了
2. 只有IsExpire要在很多方法上使用，所以需要定义成标签，面向切面编程

### 六. 关于日志
日志类型，分为项目要素操作日志，项目文件操作日志，项目操作(新建，修改，删除)日志，子账号(邀请，解绑)日志，前景操作日志(新建，修改，删除),本次迭代暂不考虑。
用户消息，用户购买，续费，升级套餐成功，被分享查看项目，被取消查看项目，被分享查看测站，被取消查看测站,本次迭代暂不考虑。
子账号消息，被邀请成为子账号，被解绑子账号，被分享(查看，编辑)项目，被取消查看或编辑项目。
本次迭代,本次迭代暂不考虑。
### 坐标转换
坐标转换用于工程布置，目标是导入54,80,2000格式的坐标，提供2个或3个公共点，计算出4参数或7参数：

1. 根据公共点计算7参数或4参数
2. 将源坐标平面直角坐标（XYH）转换为经纬度坐标（BLH），将经纬度坐标（BLH）转换为空间直角坐标（高斯逆算）
3. 根据所求参数进行坐标变换,空间直角坐标带入公式式进行七参数求解
4. 将计算结果得到的空间直角坐标变为大地坐标
5. 导入支持54，80，2000格式，支持84的各种大地坐标，如度，度分秒等
6. 导出时仅支持源坐标导出(导入的坐标)，和当前WGS84导出
7. 绘图时，会修改84坐标，但是源坐标不变

因此，源坐标应该上传至阿里云，coordinate表中保存转换的公共点，源坐标的椭球类型，84坐标的类型，导出时，选择源坐标和WGS84坐标，如果是源坐标，直接从阿里云上下载excel文件，如果是WGS84，程序收集工程布置下的线面，建筑物，匹配生成excel文件。
